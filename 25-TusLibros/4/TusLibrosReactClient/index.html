<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Tus Libros</title>

  <!-- Fonts to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <!-- Icons to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>

<body>
  <div id="root"></div>

  <script src="./lib/react.development.js" crossorigin="anonymous"></script>
  <script src="./lib/react-dom.development.js" crossorigin="anonymous"></script>
  <script src="./lib/material-ui.development.js" crossorigin="anonymous"></script>
  <script src="./lib/babel.min.js" crossorigin="anonymous"></script>
  <script src="./src/refreshbrowser.js" crossorigin="anonymous"></script>

  <!-- Libraries fallback -->
  <script>window.React || document.write('<script src="https://unpkg.com/react@16.11.0/umd/react.development.js">\x3C/script>')</script>
  <script>window.ReactDOM || document.write('<script src="https://unpkg.com/react-dom@16.11.0/umd/react-dom.development.js">\x3C/script>')</script>
  <script>window.MaterialUI || document.write('<script src="https://unpkg.com/@material-ui/core@4.6.1/umd/material-ui.development.js">\x3C/script>')</script>
  <script>window.Babel || document.write('<script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js">\x3C/script>')</script>
  <!-- end fallback -->

  <script type="text/babel" type="module">
    const {
      AppBar,
      Button,
      colors,
      Container,
      createMuiTheme,
      CssBaseline,
      Icon,
      IconButton,
      InputAdornment,
      InputLabel,
      FormControl,
      Link,
      List,
      ListItem,
      ListSubheader,
      ListItemIcon,
      ListItemText,
      makeStyles,
      OutlinedInput,
      TextField,
      ThemeProvider,
      Toolbar,
      Typography,
      CircularProgress,
    } = MaterialUI;
    const theme = createMuiTheme({
      palette: {
        primary: {
          main: '#556cd6',
        },
        secondary: {
          main: '#19857b',
        },
        error: {
          main: colors.red.A400,
        },
        background: {
          default: '#fff',
          paper: '#f5f5f5',
        },
      },
    });
    const useStyles = makeStyles(theme => ({
      root: {
        margin: theme.spacing(6, 0, 3),
      },
      lightBulb: {
        verticalAlign: 'middle',
      },
      rootToolBar: {
        flexGrow: 1,
      },
      menuButton: {
        marginRight: theme.spacing(2),
      },
      textField: {
        marginTop: theme.spacing(2),
        marginBottom: theme.spacing(2),
      },
      title: {
        flexGrow: 1,
      },
      rootList: {
        width: '100%',
        backgroundColor: theme.palette.background.paper,
        position: 'relative',
        overflow: 'auto',
        maxHeight: 300,
        marginVertical: 5
      },
      textFieldDetails: {
        margin: theme.spacing(2),
      },
      centeredDiv: {
        marginTop: theme.spacing(2),
        backgroundColor: theme.palette.primary.main,
        display: 'flex',
        justifyContent: 'center',
      }
    }));
    const getLocalAsJson = path => {
    
      var port = 8080
    
      return fetch(`http://localhost:${port}${path}`, {
        method: "GET",
        dataType: "JSON",
        headers: {
          "Access-Control-Request-Headers": "*"
        }
      })
      .then(function (response) {
        return (response.json()
          .then(function(responseContent) {
            if (!response.ok) {
              throw responseContent.error
            }
            return responseContent
          }))
     })
    }
    
    const createButtons = props => [
      {
        title: 'Log Out',
        shouldShow: props.router.current() !== '/',
        onClick: () => {
          props.router.navigate('/', { cartId: undefined })
        }
      },
      {
        title: 'Catalogo',
        shouldShow: props.router.current() !== '/' && props.router.current() !== '/checkout',
        onClick: () => { 
          props.router.navigate('/catalog')
    
        },
      },
      {
        title: 'Carrito',
        shouldShow: props.router.current() !== '/' && props.router.current() !== '/checkout',
        onClick: () => { 
          props.router.navigate('/cart')
    
        },
    
      },
      {
        title: 'Historial de Compras',
        shouldShow: props.router.current() !== '/' && props.router.current() !== '/checkout',
        onClick: () => {
    		props.router.navigate('/history')
    	},
    
      }
    ].filter(button => button.shouldShow)
    
    
    function MyToolBar(props) {
      const classes = useStyles();
      const { title, router } = props;
    
      const buttons = createButtons(props);
    
      return (
        <div className={classes.rootToolBar}>
          <AppBar position="static">
            <Toolbar>
              <Typography variant="h6" className={classes.title}>
                {title}
              </Typography>
              {buttons
                .map(button => 
                  <Button 
                    key={button.title}
                    color="inherit"
                    onClick={button.onClick}
                  >
                    {button.title}
                  </Button>
              )}
            </Toolbar>
          </AppBar>
        </div>
      )
    }
    function Login(props) {
      const { router } = props
      const classes = useStyles();
      const [values, setValues] = React.useState({
        user: '',
        password: ''
      });
    
      const [error, setError] = React.useState('');
    
      const handleChange = prop => event => {
        setValues({ ...values, [prop]: event.target.value });
      };
      const handleSend = () => {
        getLocalAsJson(`/createCart?userId=${values.user}&password=${values.password}`)
          .then(function (json) {
            router.navigate("/catalog", {...json, ...values})
          })
          .catch(function (error) {
            setError(`${error}`)
          });
      }
    
      return (
        <div>
          <Typography component="h1" gutterBottom>
            Debe iniciar sesion para realizar una compra
          </Typography>
          <FormControl fullWidth className={classes.textField} variant="outlined">
            <InputLabel htmlFor="outlined-adornment-amount">Usuario</InputLabel>
            <OutlinedInput
              label={"User"}
              id="outlined-adornment-amount"
              value={values.user}
              onChange={handleChange('user')}
              labelWidth={60}
    
            />
          </FormControl>
          <FormControl fullWidth className={classes.textField} variant="outlined">
            <InputLabel htmlFor="outlined-adornment-amount">Password</InputLabel>
            <OutlinedInput
              id="outlined-adornment-password"
              type={"password"}
              value={values.password}
              onChange={handleChange('password')}
              labelWidth={60}
    
            />
            </FormControl>
    
          <Button
            color="inherit"
            onClick={handleSend}>
            Enviar
          </Button>
    
          <Typography color="error" component="h1" gutterBottom>
            {error}
          </Typography>
        </div>
      )
    }
    
    
    function CatalogView(props) {
      const { cartId, catalog, router } = props
    
    
    
      return (
        <div>
          <Typography component="h1" gutterBottom>
            Esto son los libros a la venta
          </Typography>
          <BookList showAll catalog={catalog} cartId={cartId} router={router} />
        </div>
      )
    }
    
    function CartView(props) {
      const { router, cartId, catalog } = props
      const classes = useStyles();
    
      const [error, setError] = React.useState('');
    
    
      const checkoutCart = () => (
        getLocalAsJson(`/checkoutCart?cartId=${cartId}`)
        .then( json => {
          router.navigate('/checkout', { ticket: json })
        } )
        .catch( error => setError(error))
      )
    
      return (
        <div>
          <Typography component="h1" gutterBottom>
            Esto son los libros en el carrito
          </Typography>
          <BookList catalog={catalog} cartId={cartId} router={router} />
          <BigButton onClick={checkoutCart}>
            Checkout
          </BigButton>
          <Typography color="error" component="h1" gutterBottom>
            {error}
          </Typography>
        </div>
      )
    }
    
    class App extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          path: "/",
          user: '',
          password: '',
          catalog: {}
        };
      }
    
     retrieveCatalog = () => (
         getLocalAsJson(`/showCatalog`)
        .then(json => json.catalog )
        .catch(function (error) {
          console.error(error);
        })
     )
    
      async componentDidMount() {
        this.setState({
          catalog: await this.retrieveCatalog()
        })
      }
    
      render() {
        let title = "TusLibros Web"
        let content = "Where am I?"
        const router = {
          current: () => this.state.path,
          navigate: (path, state) => {
            this.setState({ ...state, path: path })
          }
        }
    
        if (this.state.path === "/") {
          content = (<Login
            router={router}
          />)
        } else if (this.state.path === "/catalog") {
          content = (<CatalogView
            router={router}
            cartId={this.state.cartId}
            catalog={this.state.catalog}
          />)
        } else if (this.state.path === "/cart") {
          content = (<CartView
            router={router}
            cartId={this.state.cartId}
            catalog={this.state.catalog}
          />)
        } else if (this.state.path === "/checkout") {
          content = (<SuccesfulCheckoutView
            user={this.state.user}
            password={this.state.password}
            router={router}
            catalog={this.state.catalog}
            ticket={this.state.ticket}
          />)
        } else if (this.state.path === "/history") {
          content = (<HistoryView
            user={this.state.user}
            password={this.state.password}
            router={router}
            catalog={this.state.catalog}
          />)
        } else if (this.state.path === "/bookDetails") {
          content = (<BookDetailsView
            cartId={this.state.cartId}
            isbn={this.state.isbn}
          />)
        }
    
        return (
          <div>
            <MyToolBar
              title={title}
              router={router}
            />
            <Container maxWidth="sm">
              <div style={{ marginTop: 24, }}>
                {content}
              </div>
            </Container>
          </div>
        );
      }
    }
    function BookList(props) {
      const { cartId, catalog, showAll, router } = props
      const classes = useStyles();
    
      const [cartItems, setCartItems] = React.useState({})
    
      
      const updateCartItems = () => {
        getLocalAsJson(`/listCart?cartId=${cartId}`)
        .then(function (json) {
          setCartItems(json);
        })
        .catch(function (error) {
          console.error(error);
        });
      };
    
      const addToCart = isbn => () => {
        getLocalAsJson(`/addToCart?cartId=${cartId}&bookISBN=${isbn}`)
          .then(() => {
            updateCartItems();
          })
    
      }
    
      const removeFromCart = isbn => () => {
        getLocalAsJson(`/removeFromCart?cartId=${cartId}&bookISBN=${isbn}`)
          .then(() => {
            updateCartItems();
          })
      }
      
      const showDetails = isbn => () => {
    	router.navigate('/bookDetails', {'isbn': isbn})
      }
    
      const getAmount = isbn => {
        return (cartItems[isbn] || 0).toString();
      }
    
      React.useEffect(() => {
          updateCartItems();
      }, [])
    
    
      return (
          <List component="nav" className={classes.rootList} aria-label="substrings">
            {
              Object.keys(showAll ? catalog : cartItems).map((isbn, ix) => {
                const book = catalog[isbn];
                return (
                  <ListItem
                    key={ix}
                  >
                    <ListItemText primary={isbn} />
                    <ListItemText primary={book.title} />
                      <Button
                        onClick={addToCart(isbn)}
                      >
                        +
                      </Button>
                      <ListItemText primary={getAmount(isbn)} align="center" />
                      <Button
                        onClick={removeFromCart(isbn)}
                      >
                        -
                      </Button>
                      <Button
                        onClick={showDetails(isbn)}
                      >
                        Ver detalles
                      </Button>
                  </ListItem>
                )
              })
            }
          </List>
          
      )
    }
    
    function TicketView(props) {
      const { ticket, catalog, router, user, password } = props
      const classes = useStyles();
    
      return (
        <div>
          <List component="nav" className={classes.rootList} >
            {
              ticket.items.map((item, ix) => {
                const isbn = item.item;
                const book = catalog[isbn];
                return (
                  <ListItem
                    key={ix}
                  >
                    <ListItemText primary={isbn} />
                    <ListItemText primary={book.title} />
                    <ListItemText primary={item.total} />
                    <ListItemText primary={item.quantity} />
                  </ListItem>
                )
              })
            }
          </List>
          <Typography component="h1">
            {`Total: ${ticket.total}`}
          </Typography>
        </div>
    
      )
    }
    
    function SuccesfulCheckoutView(props) {
      const { ticket, catalog, router, user, password } = props
      const classes = useStyles();
    
      const makeAnotherPurchase = () => {
        getLocalAsJson(`/createCart?userId=${user}&password=${password}`)
          .then(function (json) {
            router.navigate("/catalog", json)
          })
          .catch(function (error) {
            console.error(error)
          });
      }
    
    
    
      return (
        <div>
          <Typography>
            La compra fue realizada con exito!
          </Typography>
    
          <TicketView
            user={user}
            password={password}
            router={router}
            catalog={catalog}
            ticket={ticket}
          />
          <BigButton onClick={makeAnotherPurchase}>
            Realizar Otra Compra
            </BigButton>
        </div>
    
      )
    }
    
    function HistoryView(props) {
      const { catalog, router, user, password } = props
      const classes = useStyles();
    
      const [history, setHistory] = React.useState({});
      const [loading, setLoading] = React.useState(true);
    
      
      const updateHistory = () => {
        getLocalAsJson(`/listPurchases?userId=${user}&password=${password}`)
        .then(function (json) {
          setHistory(json);
    	  setLoading(false);
        })
        .catch(function (error) {
          console.error(error);
        });
      };
    
      React.useEffect(() => {
          updateHistory();
      }, [])
    
      if(loading){
    	  return (<CircularProgress />);
      }
      return (
        <div>
          <Typography>
            Historial de compras
          </Typography>
    
          <TicketView
            user={user}
            password={password}
            router={router}
            catalog={catalog}
            ticket={history}
          />
        </div>
      )
    }
    
    function BookDetailsView(props) {
      const { cartId, isbn } = props
      const classes = useStyles();
    
      const [details, setDetails] = React.useState();
      const [loading, setLoading] = React.useState(true);
    
      const addToCart = () => {
        getLocalAsJson(`/addToCart?cartId=${cartId}&bookISBN=${isbn}`)
          .then(() => {
            updateDetails();
          })
      }
    
      const removeFromCart = () => {
        getLocalAsJson(`/removeFromCart?cartId=${cartId}&bookISBN=${isbn}`)
          .then(() => {
            updateDetails();
          })
      }
      
      const updateDetails = () => {
    	getLocalAsJson(`/showBookInCartDetails?cartId=${cartId}&bookISBN=${isbn}`)
          .then((json) => {
            setDetails(json)
            setLoading(false)
          })
      }
    
      React.useEffect(() => {
          updateDetails();
      }, [])
      
      if(loading){
    	  return (<CircularProgress />);
      }
    
      return (
          <div>
    		<Typography variant="h4">
              {details.title}, de {details.author}
            </Typography>
    		<Typography variant="h6">
              ISBN: {isbn}
            </Typography>
            <Typography display="inline">
              Cantidad:
            </Typography>
    		  <Button
    			onClick={addToCart}
    		  >
    			+
    		  </Button>
    		  
    		<Typography display="inline">
    		  {details.quantity}
    		</Typography>
    		  <Button
    			onClick={removeFromCart}
    		  >
    			-
    		  </Button>
          </div>
          
      )
    }
    
    
    function BigButton(props) {
      const classes = useStyles();
    
      return (
        <div className={classes.centeredDiv}>
            <Button
              color="inherit"
              {...props}
            />
    
          </div>
      )
    }

    ///////////////////////////////////////////////////////////////////////////
    // Initial render
    //
    ReactDOM.render(
      <ThemeProvider theme={theme}>
        <CssBaseline />
        <App />
      </ThemeProvider>,
      document.getElementById('root')
    )
  </script>

  <!-- <button onclick="window.location.reload(true)">reload</button> -->
</body>

</html>
